<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - KickStar</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/footer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">

    <style>
        .cart-container {
            padding: 2em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th,
        td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }

        th {
            background: #f4f6f6;
        }

        td img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
        }

        .qty-input {
            width: 60px;
            padding: 4px;
            text-align: center;
        }

        .remove-btn {
            background: red;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .cart-total {
            text-align: right;
            font-size: 18px;
            margin-top: 10px;
        }

        .checkout-btn {
            background: var(--primary-color, #fd3008);
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            float: right;
        }
    </style>
</head>

<body>
    <div class="container">
        
        <header>
            <div class="header">
                <div class="logo">
                    <a href="../index.html"><img src="../images/logo2.svg" alt="" width="70px" title="KickStar"></a>
                </div>

                <div class="search-bar desktop">

                    <form action="#" method="get">
                        <input type="search" placeholder="Search Products, Categories, Brands, ..." name="q" required>
                        <i class="ri-search-line"></i>
                        <input type="submit" value="Search">
                    </form>
                </div>

                <div class="header-items">
                    <div class="help">
                        <i class="ri-questionnaire-line"></i>
                    </div>

                    <div class="account">
                        <i class="ri-account-circle-line" title="Account"></i>
                        <div class="account-dropdown">
                            <p class="login"><a href="#">Login</a></p>
                            <p class="register"><a href="#">Register</a></p>
                        </div>
                    </div>

                    <div class="cart">
                        <a href="../pages/cart.html">
                            <i class="ri-shopping-cart-line" title="Cart"></i>
                            <span id="cart-count" class="cart-count">0</span>
                        </a>
                    </div>
                </div>
            </div>

            <div class="search-bar mobile">
                <form action="#" method="get">
                    <input type="search" placeholder="Search Products, Categories, Brands, ..." name="q" required>
                    <!-- <span><i class="ri-search-line"></i></span> -->
                    <input type="submit" value="Search">
                </form>
            </div>
            <nav>
                <ul class="nav-links">
                    <li><a href="#">All</a></li>
                    <li><a href="../pages/category.html?cat=women">Women</a></li>
                    <li><a href="../pages/category.html?cat=featured" title="Featured Products">Featured</a></li>
                    <li><a href="../pages/category.html?cat=men">Men</a></li>
                    <li><a href="../pages/category.html?cat=kids">Kids</a></li>
                    <li><a href="../pages/category.html?cat=unisex">Unisex</a></li>
                    <li><a href="../pages/category.html?cat=women">New</a></li>
                    <li><a href="../pages/category.html?cat=deals">Deals</a></li>
                    <li><a href="#">Brands</a></li>
                </ul>
            </nav>

        </header>

        <div class="header-after"></div>

        <div class="cart-container">
            <h2>Your Shopping Cart</h2>
            <table id="cart-table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Details</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Subtotal</th>
                        <th>Remove</th>
                    </tr>
                </thead>
                <tbody id="cart-body"></tbody>
            </table>
            <div class="cart-total">
                <strong>Total: </strong>KES <span id="cart-total">0</span>
            </div>
            <br>
            <a href="../pages/checkout.html"><button class="checkout-btn">Proceed to Checkout</button></a>
        </div>



        <!-- âœ… Product Data -->
        <script src="../js/products.js"></script>

        <script>
            // --- Cart Utilities ---
            function getCart() { return JSON.parse(localStorage.getItem("cart") || "[]"); }
            function setCart(cart) { localStorage.setItem("cart", JSON.stringify(cart)); }
            function updateCartCount() {
                const cart = getCart();
                const count = cart.reduce((sum, item) => sum + item.qty, 0);
                document.getElementById("cart-count").textContent = count;
            }

            // --- Render Cart Page ---
            function renderCart() {
                const cart = getCart();
                const body = document.getElementById("cart-body");
                const totalEl = document.getElementById("cart-total");
                body.innerHTML = "";
                let total = 0;

                if (cart.length === 0) {
                    body.innerHTML = `<tr><td colspan="6">Your cart is empty.</td></tr>`;
                    totalEl.textContent = "0";
                    return;
                }

                cart.forEach((item, index) => {
                    // ðŸ”— Lookup actual stock from productsData
                    let stock = 1;
                    try {
                        const product = productsData[item.productIndex];
                        const variant = product.variants[item.variantIndex];
                        const sizeObj = variant.sizes[item.sizeIndex];
                        stock = sizeObj.stock_quantity;
                    } catch (e) {
                        stock = 1; // fallback if data not found
                    }

                    // Clamp qty if above stock
                    if (item.qty > stock) item.qty = stock;

                    const subtotal = item.qty * item.price;
                    total += subtotal;

                    body.innerHTML += 
                    `
          <tr>
            <td><a href="../pages/product-details.html?id=${index}" title="View Product"><img src="${item.image}" alt="${item.name}"></a></td>
            <td><a href="../pages/product-details.html?id=${index}" title="View Product">${item.name}</a><br><small>${item.color}, Size ${item.size}</small></td>
            <td>KES ${item.price}</td>
            <td>
              <input type="number" class="qty-input" min="1" max="${stock}" value="${item.qty}" data-index="${index}">
              ${stock === 0 ? "<br><small style='color:red;'>Out of Stock</small>" : ""}
            </td>
            <td>KES ${subtotal}</td>
            <td><button class="remove-btn" data-index="${index}">X</button></td>
          </tr>
        `;
                });

                totalEl.textContent = total;

                // Quantity change events
                document.querySelectorAll(".qty-input").forEach(input => {
                    input.addEventListener("change", (e) => {
                        const index = e.target.dataset.index;
                        let cart = getCart();
                        let newQty = parseInt(e.target.value, 10);
                        const product = productsData[cart[index].productIndex];
                        const variant = product.variants[cart[index].variantIndex];
                        const sizeObj = variant.sizes[cart[index].sizeIndex];
                        const stock = sizeObj.stock_quantity;

                        if (newQty < 1) newQty = 1;
                        if (newQty > stock) newQty = stock;

                        cart[index].qty = newQty;
                        setCart(cart);
                        renderCart();
                        updateCartCount();
                    });
                });

                // Remove item
                document.querySelectorAll(".remove-btn").forEach(btn => {
                    btn.addEventListener("click", (e) => {
                        const index = e.target.dataset.index;
                        let cart = getCart();
                        cart.splice(index, 1);
                        setCart(cart);
                        renderCart();
                        updateCartCount();
                    });
                });
            }

            // --- On Load ---
            updateCartCount();
            renderCart();
        </script>
    <script src="../js/context.js"></script>
    <script src="../js/footer.js"></script>
</body>

</html>