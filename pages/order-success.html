<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Success - KickStar</title>

    <link rel="shortcut icon" href="../images/logo2.svg" type="image/x-icon">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/footer.css">
    <link rel="stylesheet" href="../css/main.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #fd3008;
            --secondary-color: #00a896;
            --neutral-light-color: #f8f9fa;
            --neutral-dark-color: #2d2d2d;
            --accent-color: #ffd166;
            --snow: #fffafa;
            --anti-flash-white: #f4f6f6;
            --gray-shade-color: #dee7e7;
            --white-color: #ffffff;
            --black-color: #000000;
            --timberwolf: #ced0ce;
            --black-low-opacity: #00000033;
            --warning: #ff0000;
            --info: #2a7a55;
            --success: #2a7a55;
        }
        /* Breadcrumb */
        .breadcrumb {
            margin: 20px 0;
            font-size: 14px;
            color: var(--neutral-dark-color);
        }

        .breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
        }

        /* .breadcrumb a:hover {
            text-decoration: underline;
        } */

        /* Order Receipt Container */
        .order-receipt-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem 0;
        }

        /* Order Receipt */
        .order-receipt {
            background: var(--white-color);
            border-radius: 12px;
            border: 1px solid var(--gray-shade-color);
            padding: 30px;
            width: 100%;
            margin-bottom: 30px;
        }

        .brand-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-shade-color);
        }

        .brand-header img {
            max-width: 150px;
            margin-bottom: 15px;
        }

        .brand-header h2 {
            color: var(--success);
            font-size: 28px;
            margin-bottom: 10px;
        }

        .order-receipt p {
            margin-bottom: 15px;
            color: var(--neutral-dark-color);
        }

        .order-receipt hr {
            border: none;
            height: 1px;
            background: var(--gray-shade-color);
            margin: 20px 0;
        }

        .order-receipt h3 {
            margin-bottom: 20px;
            color: var(--neutral-dark-color);
            font-size: 22px;
        }

        .receipt-info {
            display: flex;
            margin-bottom: 10px;
        }

        .receipt-info strong {
            width: 120px;
            color: var(--neutral-dark-color);
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        thead {
            background: var(--anti-flash-white);
        }

        th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--neutral-dark-color);
            border-bottom: 2px solid var(--gray-shade-color);
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--gray-shade-color);
        }

        /* Product Info */
        .product-info {
            display: flex;
            align-items: center;
        }

        .product-image-container {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            overflow: hidden;
            margin-right: 12px;
            background: var(--anti-flash-white);
            flex-shrink: 0;
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-name {
            font-weight: 500;
        }

        .product-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .color,
        .size {
            font-size: 14px;
            color: var(--neutral-dark-color);
        }

        .quantity,
        .price,
        .subtotal {
            text-align: center;
        }

        /* Receipt Cost Summary */
        .receipt-cost-summery {
            background: var(--anti-flash-white);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            line-height: 2;
        }

        .receipt-total {
            font-weight: 700;
            font-size: 18px;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--gray-shade-color);
        }

        /* Shipping Details */
        .shipping-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .shipping-info {
            line-height: 1.6;
            background: var(--anti-flash-white);
            padding: 15px;
            border-radius: 8px;
        }

        .shipping-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .shipping-phone,
        .shipping-address {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }

        /* Signature Section */
        .signature-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-shade-color);
        }

        .line {
            width: 200px;
            height: 1px;
            background: var(--neutral-dark-color);
            margin: 10px 0;
        }

        /* Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--white-color);
        }

        .btn-primary:hover {
            background: #e02b07;
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: var(--white-color);
        }

        .btn-secondary:hover {
            background: #008f7a;
        }

        .btn-outline {
            background: transparent;
            color: var(--neutral-dark-color);
            border: 1px solid var(--gray-shade-color);
        }

        .btn-outline:hover {
            background: var(--anti-flash-white);
        }

        /* Footer Note */
        .footer-note {
            text-align: center;
            margin-top: 20px;
            color: var(--neutral-dark-color);
            font-style: italic;
        }

        /* Success Animation */
        .success-animation {
            text-align: center;
            margin-bottom: 20px;
        }

        .success-animation i {
            font-size: 64px;
            color: var(--success);
        }

        .success-animation.animate i {
            animation: bounce 1s ease-in-out;
        }

        @keyframes bounce {

            0%,
            20%,
            60%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-10px);
            }

            80% {
                transform: translateY(-5px);
            }
        }

        /* Loading Spinner */
        /* Loading Spinner */
        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }


        /* No Items & Error States */
        .no-items,
        .no-shipping {
            text-align: center;
            padding: 20px;
            color: var(--neutral-dark-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--neutral-dark-color);
        }

        .error-state i {
            font-size: 48px;
            color: var(--warning);
            margin-bottom: 20px;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .order-receipt {
                padding: 20px;
            }

            table {
                font-size: 14px;
            }

            th,
            td {
                padding: 8px 10px;
            }

            .action-buttons {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .receipt-info {
                flex-direction: column;
            }

            .receipt-info strong {
                width: auto;
                margin-bottom: 5px;
            }
        }

        @media (max-width: 576px) {
            .brand-header h2 {
                font-size: 24px;
            }

            table {
                display: block;
                overflow-x: auto;
            }

            .product-info {
                flex-direction: column;
                align-items: flex-start;
            }

            .product-image-container {
                margin-bottom: 8px;
            }
        }
    </style>
</head>

<body>
    <div class="container pages">
        <div class="breadcrumb" id="breadcrumb">
            <a href="../index.html" title="Home"><small>Home</small></a>&nbsp; &#10095; &nbsp;
            <a href="#" title="Account"><small>Account</small></a>&nbsp; &#10095; &nbsp;
            <a href="#" title="orders"><small>Orders</small></a>&nbsp; &#10095; &nbsp;
            <small>Order Confirmation</small>
        </div>

        <div class="order-receipt-container">
            <div class="success-animation">
                <i class="ri-checkbox-circle-fill"></i>
            </div>

            <div class="order-receipt" id="order-receipt">
                <div class="brand-header">
                    <!-- Using a placeholder for the logo - replace with your actual logo -->
                    <div
                        style="height: 60px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                        <h1 style="color: var(--primary-color);">KickStar</h1>
                    </div>
                    <h2>Thank You for Your Order!</h2>
                </div>

                <p>Your order has been placed successfully. A summary is below:</p>
                <hr>
                <h3>Order Receipt</h3>

                <div class="receipt-info"><strong>Order ID:</strong> <span id="order-id">#12345</span></div>
                <div class="receipt-info"><strong>Date:</strong> <span id="order-date"></span></div>
                <div class="receipt-info"><strong>Payment:</strong> <span id="order-payment">MPesa</span></div>

                <table>
                    <thead>
                        <tr>
                            <th>Product</th>
                            <!-- <th>Details</th> -->
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody id="receipt-items"></tbody>
                </table>

                <div class="receipt-cost-summery">
                    Subtotal: &nbsp;&nbsp; <span id="order-subtotal"></span><br>
                    Tax (16%): &nbsp;&nbsp; <span id="order-tax"></span><br>
                    Shipping: &nbsp;&nbsp; <span id="order-shipping"></span><br>
                    <div class="receipt-total">
                        Total Amount: <span id="order-total">0.00</span>
                    </div>
                </div>

                <div id="shipping-details" style="margin-top: 10px; margin-bottom: 20px; line-height: 1.6;"></div>

                <!-- Signature & Thank You -->
                <div class="signature-section">
                    <p>We'll notify you once your order is on its way.
                        If you chose <strong>Cash on Delivery</strong>, please have the amount ready upon delivery.
                    </p>
                    <br>
                    <p>Signed,</p>
                    <div class="line"></div>
                    <p><strong>The KickStar Team</strong></p>
                    <p style="font-size: 0.9rem; color: #6c6b6b;">Thank you for supporting sustainable fashion ðŸŒ¿
                    </p>
                </div>
            </div>

            <div class="action-buttons">
                <button id="download-receipt-btn" class="btn btn-primary">
                    <i class="ri-download-line"></i> Download Receipt (PDF)
                </button>
                <button id="continue-shopping-btn" class="btn btn-secondary">
                    <i class="ri-shopping-bag-line"></i> Continue Shopping
                </button>
                <button id="track-order-btn" class="btn btn-outline">
                    <i class="ri-map-pin-line"></i> Track Order
                </button>
            </div>

            <p class="footer-note">You can keep this receipt for your records. Thank you for shopping sustainably ðŸŒ¿</p>
        </div>
    </div>

    <script src="../js/context.js"></script>
    <script src="../js/header-template.js"></script>
    <script src="../js/header.js"></script>
    <script src="../js/products.js"></script>
    <script src="../js/footer.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Initialize the thank you page
            initOrderSuccessPage();
        });

        function initOrderSuccessPage() {
            try {
                const order = JSON.parse(localStorage.getItem("lastOrder") || "{}");
                const items = order.items || order.cart || [];
                const shippingFee = 300;

                // Update order details
                updateOrderDetails(order, shippingFee);

                // Render order items
                renderOrderItems(items);

                // Update shipping details
                updateShippingDetails(order.shippingAddress);

                // Setup PDF download
                setupPDFDownload(order);

                // Setup additional actions
                setupAdditionalActions();

                // Clear cart after successful order
                clearCart();

                // Show success animation
                showSuccessAnimation();

            } catch (error) {
                console.error("Error initializing thank you page:", error);
                showErrorState();
            }
        }

        function updateOrderDetails(order, shippingFee) {
            const subtotal = order.subtotal || calculateSubtotal(order.items || order.cart || []);
            const tax = order.tax || subtotal * 0.16; // 16% tax
            const total = order.total || (subtotal + shippingFee + tax);

            const elements = {
                'order-id': order.id || "#12345",
                'order-date': new Date().toLocaleString('en-KE', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                'order-payment': order.paymentMethod || "MPesa",
                'order-subtotal': formatCurrency(subtotal),
                'order-shipping': formatCurrency(shippingFee),
                'order-tax': formatCurrency(tax),
                'order-total': formatCurrency(total)
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
        }

        function renderOrderItems(items) {
            const itemsEl = document.getElementById("receipt-items");
            if (!itemsEl) return;

            itemsEl.innerHTML = "";

            if (items.length === 0) {
                itemsEl.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-items">
                            <i class="ri-shopping-bag-line"></i>
                            <span>No items found in this order</span>
                        </td>
                    </tr>
                `;
                return;
            }

            items.forEach(item => {
                const row = createOrderItemRow(item);
                itemsEl.appendChild(row);
            });

            // Add loading state for images
            preloadImages(items);
        }

        function createOrderItemRow(item) {
            const imageSrc = item.image || item.product || "";
            const name = item.name || item.product || "Unnamed Product";
            const qty = item.qty || item.quantity || 1;
            const price = item.price || 0;
            const color = item.color || "-";
            const size = item.size || "-";
            const subtotal = qty * price;

            const row = document.createElement("tr");
            row.className = "order-item-row";

            // Image and name cell
            const tdImage = document.createElement("td");
            tdImage.className = "product-info";

            const imgContainer = document.createElement("div");
            imgContainer.className = "product-image-container";

            const img = document.createElement("img");
            img.alt = name;
            img.className = "product-image";
            // img.src = imageSrc;

            if (imageSrc) {
                img.crossOrigin = "anonymous";
                img.src = imageSrc;
                img.onerror = () => {
                    img.src = getFallbackImage();
                };
                img.onload = () => {
                    imgContainer.classList.add('loaded');
                };
            } else {
                img.src = getFallbackImage();
            }

            imgContainer.appendChild(img);
            tdImage.appendChild(imgContainer);

            const nameSpan = document.createElement("span");
            nameSpan.className = "product-name";
            nameSpan.textContent = name;
            tdImage.appendChild(nameSpan);

            row.appendChild(tdImage);

            // Details cell
            const tdDetails = document.createElement("td");
            tdDetails.className = "product-details";
            tdDetails.innerHTML = `
                <span class="color">Color: ${color}</span>
                <span class="size">Size: ${size}</span>
            `;
            row.appendChild(tdDetails);

            // Quantity cell
            const tdQty = document.createElement("td");
            tdQty.className = "quantity";
            tdQty.textContent = qty;
            row.appendChild(tdQty);

            // Price cell
            const tdPrice = document.createElement("td");
            tdPrice.className = "price";
            tdPrice.textContent = formatCurrency(price);
            row.appendChild(tdPrice);

            // Subtotal cell
            const tdSubtotal = document.createElement("td");
            tdSubtotal.className = "subtotal";
            tdSubtotal.textContent = formatCurrency(subtotal);
            row.appendChild(tdSubtotal);

            return row;
        }

        function updateShippingDetails(shipping) {
            const shippingEl = document.getElementById("shipping-details");
            if (!shippingEl) return;

            if (shipping) {
                shippingEl.innerHTML = `
                    <div class="shipping-header">
                        <i class="ri-truck-line"></i>
                        <strong>Shipping To:</strong>
                    </div>
                    <div class="shipping-info">
                        <div class="shipping-name">${shipping.fullname}</div>
                        <div class="shipping-phone">
                            <i class="ri-phone-line"></i>
                            ${shipping.phone}
                        </div>
                        <div class="shipping-address">
                            <i class="ri-map-pin-line"></i>
                            ${shipping.address}, ${shipping.city}
                        </div>
                    </div>
                `;
            } else {
                shippingEl.innerHTML = `
                    <div class="no-shipping">
                        <i class="ri-map-pin-line"></i>
                        <em>No shipping address provided</em>
                    </div>
                `;
            }
        }



        function setupPDFDownload(order) {
            const downloadBtn = document.getElementById("download-receipt-btn");
            if (!downloadBtn) return;

            downloadBtn.addEventListener("click", () => {
                // Store original button state
                const originalHTML = downloadBtn.innerHTML;

                try {
                    // Show loading state
                    downloadBtn.innerHTML = '<i class="ri-loader-4-line spin"></i> Generating PDF...';
                    downloadBtn.disabled = true;

                    // Generate PDF 
                    generatePDF(order);

                } catch (error) {
                    console.error("PDF generation failed:", error);
                    alert("Sorry, we couldn't generate your receipt. Please try again.");
                } finally {
                    // Reset button state after a small delay to ensure UI updates
                    setTimeout(() => {
                        downloadBtn.innerHTML = '<i class="ri-download-line"></i> Download Receipt (PDF)';
                        downloadBtn.disabled = false;
                    }, 1000);
                }
            });
        }

        function generatePDF(order) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const items = order.items || order.cart || [];
            const shippingFee = 300;
            const subtotal = order.subtotal || calculateSubtotal(items);
            const tax = order.tax || subtotal * 0.16;
            const total = order.total || (subtotal + shippingFee + tax);
            const shipping = order.shippingAddress;

            let yPosition = 20;

            // Header Section
            doc.setFontSize(24);
            doc.setTextColor(0, 168, 150); // Secondary color
            doc.text("KICKSTAR", 105, yPosition, { align: 'center' });

            yPosition += 10;
            doc.setFontSize(16);
            doc.setTextColor(253, 48, 8); // Primary color
            doc.text("ORDER CONFIRMATION", 105, yPosition, { align: 'center' });

            yPosition += 15;
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text("Thank you for your order! Your purchase supports sustainable fashion.", 105, yPosition, { align: 'center' });

            yPosition += 20;

            // Order Information
            doc.setFontSize(14);
            doc.setTextColor(45, 45, 45); // Dark color
            doc.text("ORDER DETAILS", 20, yPosition);

            yPosition += 10;
            doc.setFontSize(10);
            doc.text(`Order ID: ${order.id || "#12345"}`, 20, yPosition);
            doc.text(`Date: ${new Date().toLocaleString('en-KE')}`, 120, yPosition);

            yPosition += 6;
            doc.text(`Payment Method: ${order.paymentMethod || "MPesa"}`, 20, yPosition);

            yPosition += 15;

            // Shipping Information
            if (shipping) {
                doc.setFontSize(14);
                doc.text("SHIPPING ADDRESS", 20, yPosition);

                yPosition += 8;
                doc.setFontSize(10);
                doc.text(`${shipping.fullname}`, 20, yPosition);
                yPosition += 5;
                doc.text(`${shipping.phone}`, 20, yPosition);
                yPosition += 5;
                doc.text(`${shipping.address}, ${shipping.city}`, 20, yPosition);

                yPosition += 15;
            }

            // Order Items Table
            doc.setFontSize(14);
            doc.text("ORDER ITEMS", 20, yPosition);
            yPosition += 10;

            // Table Headers - Adjusted for images
            doc.setFillColor(244, 246, 246); // Light gray background
            doc.rect(20, yPosition, 170, 8, 'F');
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text("Product", 35, yPosition + 6); // Moved right to accommodate image
            doc.text("Details", 90, yPosition + 6);
            doc.text("Qty", 140, yPosition + 6);
            doc.text("Price", 150, yPosition + 6);
            doc.text("Subtotal", 170, yPosition + 6);

            yPosition += 12;

            // Order Items with Images
            if (items.length > 0) {
                // Process items sequentially to handle async image loading
                processItemsForPDF(doc, items, yPosition, subtotal, tax, shippingFee, total, shipping, order);
            } else {
                doc.text("No items in this order", 22, yPosition);
                yPosition += 10;
                completePDF(doc, yPosition, subtotal, tax, shippingFee, total, order);
            }
        }

        function processItemsForPDF(doc, items, startY, subtotal, tax, shippingFee, total, shipping, order) {
            let yPosition = startY;
            let processedItems = 0;

            items.forEach((item, index) => {
                const name = item.name || item.product || "Unnamed Product";
                const qty = item.qty || item.quantity || 1;
                const price = item.price || 0;
                const color = item.color || "-";
                const size = item.size || "-";
                const itemSubtotal = qty * price;
                const imageSrc = item.image || '';

                // Alternate row background
                if (index % 2 === 0) {
                    doc.setFillColor(248, 249, 250);
                    doc.rect(20, yPosition - 4, 170, 12, 'F');
                }

                doc.setTextColor(0, 0, 0);

                // Add product image if available
                if (imageSrc) {
                    try {
                        // Create a temporary image to check if it loads
                        const img = new Image();
                        img.crossOrigin = "Anonymous";
                        img.onload = function () {
                            try {
                                // Add image to PDF (15x15px)
                                doc.addImage(img, 'JPEG', 22, yPosition - 3, 15, 15);
                                addTextToRow();
                            } catch (e) {
                                console.warn('Could not add image to PDF, using fallback:', e);
                                addFallbackImage();
                            }
                        };
                        img.onerror = function () {
                            addFallbackImage();
                        };
                        img.src = imageSrc;
                    } catch (e) {
                        addFallbackImage();
                    }
                } else {
                    addFallbackImage();
                }

                function addFallbackImage() {
                    // Add a simple rectangle as fallback
                    doc.setFillColor(220, 220, 220);
                    doc.rect(22, yPosition - 3, 15, 15, 'F');
                    doc.setTextColor(150, 150, 150);
                    doc.setFontSize(6);
                    doc.text("No", 26, yPosition + 3);
                    doc.text("Img", 26, yPosition + 6);
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    addTextToRow();
                }

                function addTextToRow() {
                    // Product name (starting after image)
                    doc.text(name.substring(0, 20), 40, yPosition + 4);

                    // Other details
                    doc.text(`${color}, ${size}`, 90, yPosition + 4);
                    doc.text(qty.toString(), 140, yPosition + 4);
                    doc.text(`KES ${price.toFixed(2)}`, 150, yPosition + 4);
                    doc.text(`KES ${itemSubtotal.toFixed(2)}`, 170, yPosition + 4);

                    yPosition += 12;
                    processedItems++;

                    // Check if all items are processed
                    if (processedItems === items.length) {
                        completePDF(doc, yPosition, subtotal, tax, shippingFee, total, order);
                    }

                    // Page break check
                    if (yPosition > 250 && processedItems < items.length) {
                        doc.addPage();
                        yPosition = 20;

                        // Add table headers on new page
                        doc.setFillColor(244, 246, 246);
                        doc.rect(20, yPosition, 170, 8, 'F');
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        doc.text("Product", 35, yPosition + 6);
                        doc.text("Details", 90, yPosition + 6);
                        doc.text("Qty", 140, yPosition + 6);
                        doc.text("Price", 150, yPosition + 6);
                        doc.text("Subtotal", 170, yPosition + 6);
                        yPosition += 12;
                    }
                }
            });
        }

        function completePDF(doc, yPosition, subtotal, tax, shippingFee, total, order) {
            yPosition += 10;

            // Cost Summary
            doc.setDrawColor(200, 200, 200);
            doc.line(20, yPosition, 190, yPosition);
            yPosition += 8;

            doc.setFontSize(11);
            doc.text("Subtotal:", 120, yPosition);
            doc.text(`KES ${subtotal.toFixed(2)}`, 170, yPosition, { align: 'right' });

            yPosition += 6;
            doc.text("Tax (16%):", 120, yPosition);
            doc.text(`KES ${tax.toFixed(2)}`, 170, yPosition, { align: 'right' });

            yPosition += 6;
            doc.text("Shipping:", 120, yPosition);
            doc.text(`KES ${shippingFee.toFixed(2)}`, 170, yPosition, { align: 'right' });

            yPosition += 10;
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("TOTAL:", 120, yPosition);
            doc.text(`KES ${total.toFixed(2)}`, 170, yPosition, { align: 'right' });

            yPosition += 20;

            // Footer Message
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);

            const footerText = [
                "We'll notify you once your order is on its way.",
                "If you chose Cash on Delivery, please have the amount ready upon delivery.",
                "",
                "Signed,",
                "The KickStar Team",
                "Thank you for supporting sustainable fashion"
            ];

            footerText.forEach(line => {
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }
                doc.text(line, 105, yPosition, { align: 'center' });
                yPosition += 5;
            });

            // Save the PDF
            doc.save(`KickStar_Receipt_${order.id || Date.now()}.pdf`);

            // Track download event
            trackEvent('receipt_downloaded', { orderId: order.id });
        }



        function setupAdditionalActions() {
            // Continue shopping button
            const continueBtn = document.getElementById("continue-shopping-btn");
            if (continueBtn) {
                continueBtn.addEventListener("click", () => {
                    window.location.href = "../index.html";
                });
            }

            // Track order button
            const trackBtn = document.getElementById("track-order-btn");
            if (trackBtn) {
                trackBtn.addEventListener("click", () => {
                    const order = JSON.parse(localStorage.getItem("lastOrder") || "{}");
                    alert(`Your order ${order.id} has been confirmed! You will receive tracking information via SMS.`);
                });
            }
        }

        function clearCart() {
            try {
                localStorage.removeItem("cart");
                // Dispatch event for other parts of the app
                window.dispatchEvent(new Event('cartUpdated'));
            } catch (error) {
                console.error("Error clearing cart:", error);
            }
        }

        function showSuccessAnimation() {
            const successIcon = document.querySelector('.success-animation i');
            if (successIcon) {
                successIcon.classList.add('animate');
                setTimeout(() => {
                    successIcon.classList.remove('animate');
                }, 2000);
            }
        }

        function showErrorState() {
            const receiptEl = document.getElementById("order-receipt");
            if (receiptEl) {
                receiptEl.innerHTML = `
                    <div class="error-state">
                        <i class="ri-error-warning-line"></i>
                        <h3>Unable to Load Order Details</h3>
                        <p>There was a problem loading your order information.</p>
                        <button onclick="window.location.href='../index.html'" class="btn btn-primary">
                            Continue Shopping
                        </button>
                    </div>
                `;
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            return `KES ${parseFloat(amount).toFixed(2)}`;
        }

        function calculateSubtotal(items) {
            return items.reduce((total, item) => {
                const qty = item.qty || item.quantity || 1;
                const price = item.price || 0;
                return total + (qty * price);
            }, 0);
        }

        function getFallbackImage() {
            return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f0f0f0'/%3E%3Ctext x='50' y='50' font-family='Arial' font-size='12' text-anchor='middle' fill='%23999'%3ENo Image%3C/text%3E%3C/svg%3E";
        }

        function preloadImages(items) {
            items.forEach(item => {
                const imageSrc = item.image || item.product;
                if (imageSrc) {
                    const img = new Image();
                    img.src = imageSrc;
                }
            });
        }

        function trackEvent(eventName, properties = {}) {
            // In a real app, you would send this to your analytics service
            console.log(`Tracking: ${eventName}`, properties);
        }
    </script>

</body>

</html>